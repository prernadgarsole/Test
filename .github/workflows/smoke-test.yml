name: Asana Integration Smoke Test

on:
  push:
    branches:
      - main

jobs:
  smoke-test:
    runs-on: ubuntu-latest

    steps:
      - name: Validate Asana Integration
        run: |
          const axios = require('axios');
          const token = '1/1204760161937729:b3bcc2c3e471c304b84924c4d1290a59';
          const projectId = '1201711203404129';
          const workspaceId = '10415102240585';

          const validateToken = async () => {
            try {
              const response = await axios.get('https://app.asana.com/api/1.0/users/me', {
                headers: {
                  'Authorization': 'Bearer ' + token,
                },
              });

              if (response.status === 200) {
                console.log('Token validation successful');
                validateProjectAndWorkspace();
              } else {
                console.error('Token validation failed');
                throw new Error('Token validation failed');
              }
            } catch (error) {
              console.error('Error validating token:', error.response.data.errors);
              throw error;
            }
          };

          const validateProjectAndWorkspace = async () => {
            try {
              const response = await axios.get(`https://app.asana.com/api/1.0/projects/${projectId}`, {
                headers: {
                  'Authorization': 'Bearer ' + token,
                },
              });

              if (response.status === 200 && response.data.data.workspace.id === workspaceId) {
                console.log('Project and workspace validation successful');
                // Proceed with your integration logic here
              } else {
                console.error('Project or workspace validation failed');
                throw new Error('Project or workspace validation failed');
              }
            } catch (error) {
              console.error('Error validating project or workspace:', error.response.data.errors);
              throw error;
            }
          };

          validateToken().catch((error) => {
            console.error('Smoke test failed:', error);
            process.exit(1); // Exit the process with a non-zero status code to mark the workflow as failed
          });
